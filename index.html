<!DOCTYPE html><html lang="id"><head><meta name="x-poe-datastore-behavior" content="local_only"><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Aplikasi Belajar SMP ‚Äî Final</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="description" content="Aplikasi belajar SMP lengkap: jadwal, todo, latihan, paket kustom, admin lock, ekspor/impor, PDF &amp; share.">

  <style>
  :root {
    --bg: #0b1020; --card: #151b2f; --muted: #8aa0ff; --text: #eaf0ff; --sub: #c7cffc;
    --accent: #6ea8fe; --ok: #28c281; --warn: #ffb020; --danger: #ff5d5d;
    --radius: 14px; --border: rgba(255,255,255,.08);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  [data-theme="light"] {
    --bg: #f6f8ff; --card: #fff; --muted: #5566cc; --text: #111525; --sub: #445;
    --accent: #3b6cff; --border: rgba(17,21,37,.08); --shadow: 0 10px 30px rgba(17,21,37,.08);
  }
  * { box-sizing: border-box; }
  html, body {
    height: 100%; margin: 0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: linear-gradient(180deg, var(--bg), #071025);
    color: var(--text); transition: .2s;
    /* Mobile first width */
    max-width: 480px;
    margin-left: auto;
    margin-right: auto;
  }
  body {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }
  header {
    position: sticky; top: 0; backdrop-filter: saturate(140%) blur(8px);
    padding: 12px 10px; background: rgba(11,16,32,.6);
    border-bottom: 1px solid var(--border); z-index: 10;
  }
  [data-theme="light"] header { background: rgba(255,255,255,.85); }
  .wrap { max-width: 480px; margin: 0 auto; }
  .brand { display: flex; gap: 12px; align-items: center; }
  .logo { width: 38px; height: 38px; border-radius: 10px;
    background: radial-gradient(circle at 20% 20%, #6ea8fe, #4f5bd5);
    box-shadow: 0 8px 24px rgba(78,107,255,.25);
  }
  h1 { margin: 0; font-size: 16px; line-height: 1.1; }
  .sub { font-size: 12px; color: var(--sub); }
  .controls { display: flex; gap: 10px; align-items: center; margin-left: auto; }
  .switch { position: relative; width: 46px; height: 26px; border-radius: 999px;
    background: #0e1429; border: 1px solid var(--border); cursor: pointer;
  }
  .knob { position: absolute; top: 2px; left: 2px; width: 20px; height: 20px;
    border-radius: 50%; background: #fff; transition: left .2s;
  }
  [data-theme="light"] .switch { background: #e9ecff; }
  [data-theme="light"] .knob { left: 22px; }

  /* Tabs */
  .tabs { display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; }
  .tab-btn {
    background: var(--card); border: 1px solid var(--border);
    padding: 8px 12px; border-radius: 10px; cursor: pointer;
    font-weight: 600; color: var(--text); font-size: 14px;
    white-space: nowrap;
  }
  .tab-btn[aria-selected="true"] {
    background: linear-gradient(180deg, #141a2d, #0f1530);
    box-shadow: var(--shadow); border-color: transparent;
  }
  [data-theme="light"] .tab-btn[aria-selected="true"] { background: var(--card); }

  main { padding: 10px 0 70px 0; flex: 1 0 auto; }
  .grid { display: block; gap: 16px; }
  .card {
    background: linear-gradient(180deg, #141a2d, #10162a);
    border-radius: 12px; border: 1px solid var(--border);
    box-shadow: var(--shadow); overflow: hidden; margin-bottom: 16px;
  }
  [data-theme="light"] .card { background: var(--card); }
  .head { padding: 12px 14px; border-bottom: 1px dashed var(--border); }
  .body { padding: 12px 14px; }
  label { display: block; font-size: 12px; color: var(--sub); margin-bottom: 4px; }
  input,select,textarea,button {
    padding: 9px; border-radius: 10px; border: 1px solid var(--border);
    background: transparent; color: var(--text); width: 100%; box-sizing: border-box; font-size: 14px;
  }
  [data-theme="light"] input,
  [data-theme="light"] select,
  [data-theme="light"] textarea { background: #f7f8ff; color: var(--text); }
  textarea { min-height: 80px; }
  .row { display: block; gap: 10px; }
  .cols-2 > * { width: 100%; display: block; margin-bottom: 8px; }
  .cols-3 > * { width: 100%; display: block; margin-bottom: 8px; }

  .btn {
    display: inline-flex; align-items: center; justify-content: center; gap: 8px;
    padding: 8px 12px; border-radius: 10px; cursor: pointer; border: 0; font-size: 14px;
  }
  .btn.primary { background: linear-gradient(180deg, #5f8bff, #4669ff); color: white; }
  .btn.ghost { background: transparent; color: var(--sub); border: 1px dashed var(--border); }
  .btn.warn { background: linear-gradient(180deg, #ffb56b, #ff9442); color: #111; }
  .btn.danger { background: linear-gradient(180deg, #ff6e6e, #ff4d4d); color: white; }

  .list { display: flex; flex-direction: column; gap: 10px; }
  .item { display: flex; gap: 12px; align-items: flex-start; padding: 10px;
    background: #0f152a; border-radius: 10px; border: 1px solid var(--border); }
  [data-theme="light"] .item { background: #f7f8ff; }
  .item .grow { flex: 1; }
  .pill {
    font-size: 11px; padding: 6px 10px; border-radius: 999px;
    background: rgba(255,255,255,.03); border: 1px solid var(--border);
  }
  .question { padding: 12px; border-radius: 10px; background: #0f152a; border: 1px solid var(--border); }
  [data-theme="light"] .question { background: #fff; }
  .options { display: grid; gap: 8px; margin-top: 8px; }
  .opt { display: flex; gap: 10px; align-items: center; padding: 10px; border-radius: 10px;
    background: #0e1429; cursor: pointer; border: 1px solid var(--border); }
  [data-theme="light"] .opt { background: #fff; color: var(--text); }
  .builder { display: block; gap: 12px; }
  .qbox { padding: 10px; border-radius: 10px; border: 1px dashed var(--border); background: transparent; margin-bottom: 10px; }
  .qrow { display: grid; gap: 8px; grid-template-columns: 1fr 60px; margin-bottom: 7px;}
  .footer { text-align: center; color: var(--sub); padding: 16px 4px 10px 4px; font-size: 13px; background: none; }

  .small { font-size: 12px; color: var(--sub); }
  .flex { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  .tools { display: flex; gap: 8px; flex-wrap: wrap; }

  /* Modal responsive + scroll */
  .modal {
    position: fixed;
    left: 0; top: 0;
    width: 100vw; height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.5);
    z-index: 2000;
    padding: 10px;
  }
  .modal .inner {
    background: var(--card);
    padding: 12px;
    border-radius: 12px;
    min-width: 0;
    width: 98vw;
    max-width: 420px;
    max-height: 92vh;
    overflow-y: auto;
    box-sizing: border-box;
    margin: auto;
    display: block;
  }
  [data-theme="light"] .modal .inner {
    background: #fff; color: var(--text);
  }
  /* Modal mobile, always mobile look */
  @media (max-width: 600px) {
    .wrap, main, body, html {
      max-width: 100vw !important;
      min-width: 0;
    }
    .modal .inner {
      width: 98vw;
      max-width: 98vw;
      max-height: 92vh;
      padding: 9px;
    }
  }
  /* Donasi footer */
  #donateFooter {
    position: fixed;
    bottom: 0; left: 0;
    width: 100vw;
    background: var(--card);
    border-top: 1px solid var(--border);
    color: var(--text);
    font-size: 1rem;
    text-align: center;
    padding: 10px 0 9px 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    z-index: 100;
    box-sizing: border-box;
  }
  #donateFooter a {
    color: #f97316;
    font-weight: 600;
    text-decoration: none;
  }
  #donateFooter a:hover {
    text-decoration: underline;
  }
  /* Table for mobile */
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th, td { padding: 5px; text-align: left; }
  th { background: var(--card); color: var(--sub); }
  /* Hide scrollbars on mobile for modal inner */
  .modal .inner::-webkit-scrollbar { display: none; }
  </style>
<script src="https://puc.poecdn.net/authenticated_preview_page/syncedState.bd4eeeb8e8e02052ee92.js"></script></head>

<body>
<header>
  <div class="wrap" style="display:flex;align-items:center;">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>Belajar Harian + Bank Soal</h1>
        <div class="sub">Versi final ‚Äî fitur lengkap ‚Ä¢ Data lokal</div>
      </div>
    </div>
    <div class="controls" style="margin-left:auto">
      <div class="small">Admin</div>
      <div class="tools">
        <button class="btn ghost" id="btnAdmin">üîê Admin</button>
        <div class="switch" id="switchTheme" role="button" tabindex="0"><div class="knob" id="knob"></div></div>
      </div>
    </div>
  </div>
  <div class="wrap">
    <nav class="tabs" role="tablist">
      <button class="tab-btn" role="tab" aria-selected="true" data-tab="jadwal">üìÖ Jadwal</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="todo">‚úÖ To-Do</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="latihan">üìù Latihan</button>
      <button class="tab-btn" role="tab" aria-selected="false" data-tab="progres">üìä Progres</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- ====================== TAB JADWAL ====================== -->
  <section id="tab-jadwal" class="grid" role="tabpanel" aria-hidden="false">
    <div class="card">
      <div class="head"><h2>Tambah Jadwal Pelajaran</h2></div>
      <div class="body">
        <form id="formJadwal" class="row cols-3">
          <div><label>Hari</label><select id="hari"><option>Senin</option><option>Selasa</option><option>Rabu</option><option>Kamis</option><option>Jumat</option><option>Sabtu</option></select></div>
          <div><label>Mapel</label><input id="mapel" placeholder="contoh: Matematika"></div>
          <div class="cols-2">
            <div><label>Mulai</label><input id="mulai" type="time"></div>
            <div><label>Selesai</label><input id="selesai" type="time"></div>
          </div>
          <div><label>Guru (opsional)</label><input id="guru" placeholder="nama guru"></div>
          <div><label>&nbsp;</label><button class="btn primary" type="submit">+ Tambah</button></div>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="head"><h2>Jadwal Mingguan</h2></div>
      <div class="body" id="listJadwal"><div class="small">Belum ada jadwal. Tambahkan di formulir.</div></div>
    </div>
  </section>

  <!-- ====================== TAB TODO ====================== -->
  <section id="tab-todo" class="grid" role="tabpanel" aria-hidden="true" style="display:none">
    <div class="card">
      <div class="head"><h2>Tambah Tugas / PR</h2></div>
      <div class="body">
        <form id="formTodo" class="row cols-3">
          <div><label>Judul</label><input id="judulTodo" placeholder="contoh: PR Matematika bab Persentase"></div>
          <div><label>Jenis</label><select id="jenisTodo"><option>PR</option><option>Ujian</option><option>Catatan</option></select></div>
          <div><label>Mapel</label><input id="mapelTodo" placeholder="Matematika / IPA"></div>
          <div><label>Jatuh Tempo</label><input id="tanggalTodo" type="date"></div>
          <div><label>Keterangan</label><textarea id="catatanTodo"></textarea></div>
          <div><label>&nbsp;</label><button class="btn primary" type="submit">+ Tambah</button></div>
        </form>
      </div>
    </div>
    <div class="card">
      <div class="head"><h2>Daftar Tugas</h2></div>
      <div class="body"><div class="list" id="listTodo"></div></div>
    </div>
  </section>

  <!-- ====================== TAB LATIHAN ====================== -->
  <section id="tab-latihan" class="grid" role="tabpanel" aria-hidden="true" style="display:none">
    <div class="card">
      <div class="head"><h2>Latihan &amp; Paket Soal</h2></div>
      <div class="body">
        <div class="row cols-3">
          <div><label>Paket Soal</label><select id="paket"></select></div>
          <div><label>Jumlah</label><select id="jumlah"><option>5</option><option>10</option></select></div>
          <div style="align-self:end"><button class="btn primary" id="mulaiQuiz">Mulai Latihan</button></div>
        </div>
        <div id="areaQuiz" style="margin-top:12px"></div>
      </div>
    </div>
    <div class="card">
      <div class="head"><h2>Riwayat Skor</h2></div>
      <div class="body"><table id="tabelSkor"><thead><tr><th>Tanggal</th><th>Paket</th><th>Benar</th><th>Total</th><th>Skor</th></tr></thead><tbody></tbody></table></div>
    </div>
    <div class="card">
      <div class="head"><h2>Builder Paket Soal (Kustom)</h2></div>
      <div class="body builder">
        <div class="row cols-3">
          <div><label>Judul Paket</label><input id="pkgTitle" placeholder="IPA ‚Ä¢ Ekosistem"></div>
          <div><label>Tag/Mapel</label><input id="pkgTag" placeholder="IPA / IPS / B.Indo"></div>
          <div style="align-self:end"><button class="btn ghost" id="addQ">+ Tambah Soal</button></div>
        </div>
        <div id="qInputs"></div>
        <div class="flex"><button class="btn primary" id="savePkg">üíæ Simpan Paket</button><button class="btn warn" id="clearInputs">‚Ü∫ Bersihkan</button></div>
        <div class="small">Setelah paket disimpan, kamu bisa <b>kunci paket</b> melalui Admin untuk mencegah perubahan.</div>
      </div>
    </div>
  </section>
  <!-- ====================== TAB PROGRES ====================== -->
  <section id="tab-progres" role="tabpanel" aria-hidden="true" style="display:none">
    <div class="card">
      <div class="head"><h2>Ringkasan Progres</h2></div>
      <div class="body">
        <div class="kpi" style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
          <div class="card" style="padding:12px"><div class="small">Tugas aktif</div><div id="kpiTodoAktif" style="font-size:22px;font-weight:800">0</div></div>
          <div class="card" style="padding:12px"><div class="small">Tugas selesai</div><div id="kpiTodoSelesai" style="font-size:22px;font-weight:800">0</div></div>
          <div class="card" style="padding:12px"><div class="small">Jadwal</div><div id="kpiJadwal" style="font-size:22px;font-weight:800">0</div></div>
          <div class="card" style="padding:12px"><div class="small">Rata-rata skor</div><div id="kpiSkor" style="font-size:22px;font-weight:800">0</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="head"><h2>Data &amp; Backup</h2></div>
      <div class="body">
        <div class="row cols-3">
          <div><label>Ekspor Data (.json)</label><button class="btn ghost" id="exportJSON">Download JSON</button></div>
          <div><label>Impor Data (.json)</label><input type="file" id="importFile" accept="application/json"></div>
          <div><label>Ekspor Laporan (PDF)</label><button class="btn primary" id="exportPDF">Cetak / Simpan PDF</button></div>
        </div>
        <div style="margin-top:10px" class="small">Setelah cetak PDF, kamu bisa bagikan melalui WhatsApp secara manual. Tombol 'Bagikan via WA' akan membuka chat wa.me dengan pesan siap dikirim.</div>
        <div style="margin-top:10px" class="flex"><button class="btn ghost" id="shareWa">Bagikan via WhatsApp (wa.me)</button></div>
      </div>
    </div>
  </section>
</main>

<footer class="footer">v1.0 ‚Ä¢ Final ‚Ä¢ Semua data tersimpan lokal di perangkat ‚Ä¢ Admin control tersedia</footer>
<footer id="donateFooter">
  <span>Gratis untuk semua</span>
  <a href="https://saweria.co/valitio" target="_blank" rel="noopener noreferrer">
    üíù Dukung via Saweria
  </a>
</footer>

<!-- Admin Modal -->
<div id="modalAdmin" style="display:none" class="modal" aria-hidden="true">
  <div class="inner">
    <h3>Panel Admin</h3>
    <div class="small">Login untuk mengakses fitur edit/hapus, kunci paket, ganti password.</div>
    <div style="margin-top:8px" id="adminArea">
      <!-- login / controls rendered here -->
    </div>
    <div style="margin-top:10px; text-align:right"><button class="btn ghost" id="closeAdmin">Tutup</button></div>
  </div>
</div>

<script>
// Utilities
const LS = {
  get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch(e){ return d } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
};
function uid(){ return crypto.randomUUID(); }
function now(){ return new Date().toLocaleString('id-ID'); }

// Theme
(function themeInit(){
  const t = LS.get('app_theme','dark');
  if(t==='light') document.documentElement.setAttribute('data-theme','light');
  const sw = document.getElementById('switchTheme');
  function toggle(){
    const cur = document.documentElement.hasAttribute('data-theme') ? 'light':'dark';
    if(cur==='light'){
      document.documentElement.removeAttribute('data-theme');
      LS.set('app_theme','dark');
    } else {
      document.documentElement.setAttribute('data-theme','light');
      LS.set('app_theme','light');
    }
  }
  sw.addEventListener('click', toggle);
  sw.addEventListener('keydown', e=>{ if(e.key==='Enter' || e.key===' ') toggle(); });
})();

// Tabs
const tabs = document.querySelectorAll('.tab-btn');
const sections = {
  jadwal: document.getElementById('tab-jadwal'),
  todo: document.getElementById('tab-todo'),
  latihan: document.getElementById('tab-latihan'),
  progres: document.getElementById('tab-progres')
};
tabs.forEach(t=>t.addEventListener('click', ()=>{
  tabs.forEach(b=>b.setAttribute('aria-selected','false'));
  t.setAttribute('aria-selected','true');
  const id=t.dataset.tab;
  Object.values(sections).forEach(s=> s.style.display='none');
  sections[id].style.display='block';
  if(id==='progres') renderKPI();
  if(id==='latihan') populatePaketOptions();
}));

// ========== JADWAL ==========
const formJadwal = document.getElementById('formJadwal');
const listJadwal = document.getElementById('listJadwal');
function renderJadwal(){
  const data = LS.get('jadwal',[]);
  if(!data.length){
    listJadwal.innerHTML='<div class="small">Belum ada jadwal. Tambahkan di formulir.</div>'; return;
  }
  const byDay = data.reduce((a,x)=>{ (a[x.hari]??=[]).push(x); return a; },{});
  const order=['Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
  listJadwal.innerHTML = order.map(day=>{
    const rows = (byDay[day]||[]).sort((a,b)=> a.mulai.localeCompare(b.mulai)).map(it=>
      `<tr><td>${it.mulai}‚Äì${it.selesai}</td><td><b>${it.mapel}</b><div class="small">${it.guru||''}</div></td><td><button class="btn ghost" data-del="${it.id}">Hapus</button></td></tr>`
    ).join('');
    if(!rows) return '';
    return `<div class="item"><div class="pill">${day}</div><div class="grow"><table style="width:100%"><thead><tr><th style="width:30%">Waktu</th><th>Mapel</th><th></th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
  }).join('');
  listJadwal.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
    const id=b.getAttribute('data-del');
    const after = LS.get('jadwal',[]).filter(x=>x.id!==id);
    LS.set('jadwal',after);
    renderJadwal();
    renderKPI();
  });
}
formJadwal.addEventListener('submit', e=>{
  e.preventDefault();
  const o={id:uid(),hari:document.getElementById('hari').value,mapel:document.getElementById('mapel').value.trim(),mulai:document.getElementById('mulai').value,selesai:document.getElementById('selesai').value,guru:document.getElementById('guru').value.trim()};
  if(!o.mapel||!o.mulai||!o.selesai) return;
  const data=LS.get('jadwal',[]); data.push(o); LS.set('jadwal',data);
  formJadwal.reset(); renderJadwal(); renderKPI();
});
renderJadwal();

// ========== TODO ==========
const formTodo=document.getElementById('formTodo'), listTodo=document.getElementById('listTodo');
function renderTodo(){
  const arr=LS.get('todo',[]);
  if(!arr.length){
    listTodo.innerHTML='<div class="small">Belum ada tugas. Tambahkan di formulir.</div>'; return;
  }
  listTodo.innerHTML = arr.sort((a,b)=> (a.selesai===b.selesai?0:(a.selesai?1:-1))).map(it=>
    `<div class="item"><input type="checkbox" ${it.selesai?'checked':''} data-toggle="${it.id}"/><div class="grow"><div style="display:flex;gap:8px"><div class="pill">${it.jenis}</div>${it.mapel?`<div class="pill">${it.mapel}</div>`:''}${it.tanggal?`<div class="pill">Jt: ${new Date(it.tanggal).toLocaleDateString('id-ID')}</div>`:''}</div><div style="margin-top:6px"><b>${it.judul}</b></div><div class="small">${it.catatan||''}</div></div><div><button class="btn ghost" data-del="${it.id}">Hapus</button></div></div>`
  ).join('');
  listTodo.querySelectorAll('[data-toggle]').forEach(c=>c.onchange=()=>{
    const id=c.getAttribute('data-toggle');
    const data=LS.get('todo',[]).map(x=> x.id===id?{...x,selesai:!x.selesai}:x);
    LS.set('todo',data); renderTodo(); renderKPI();
  });
  listTodo.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{
    const id=b.getAttribute('data-del');
    const after=LS.get('todo',[]).filter(x=>x.id!==id);
    LS.set('todo',after); renderTodo(); renderKPI();
  });
}
formTodo.addEventListener('submit', e=>{
  e.preventDefault();
  const o={id:uid(), judul:document.getElementById('judulTodo').value.trim(), jenis:document.getElementById('jenisTodo').value, mapel:document.getElementById('mapelTodo').value.trim(), tanggal:document.getElementById('tanggalTodo').value, catatan:document.getElementById('catatanTodo').value.trim(), selesai:false};
  if(!o.judul) return;
  const arr=LS.get('todo',[]); arr.push(o); LS.set('todo',arr);
  formTodo.reset(); renderTodo(); renderKPI();
});
renderTodo();

// ========== BUILT-IN BANK =========
const bank_builtin = {
  "Matematika ‚Ä¢ Persentase": [
    {q:'Harga sebuah buku Rp40.000 didiskon 15%. Berapa harga setelah diskon?', opts:['Rp34.000','Rp36.000','Rp38.500','Rp32.000'], a:0, exp:'15% √ó 40.000 = 6.000 ‚Üí 40.000 ‚àí 6.000 = 34.000'},
    {q:'25% dari 360 adalah ...', opts:['72','80','85','90'], a:3, exp:'25% √ó 360 = 90'},
    {q:'Sebuah nilai naik dari 200 ke 260. Persentase kenaikan adalah ...', opts:['20%','25%','30%','40%'], a:2, exp:'Kenaikan 60 dari 200 ‚Üí 60/200 = 0.3 = 30%'}
  ],
  "Matematika ‚Ä¢ Perbandingan": [
    {q:'Perbandingan Ali:Budi = 2:3. Jika total 50, Ali berapa?', opts:['20','30','15','25'], a:0, exp:'2/5√ó50=20'},
    {q:'Jika 5 pekerja selesai 12 hari, 10 pekerja selesai ...', opts:['6 hari','12 hari','24 hari','10 hari'], a:0, exp:'x=6'}
  ],
  "Matematika ‚Ä¢ Luas & Keliling": [
    {q:'Luas persegi sisi 14 cm adalah ...', opts:['196 cm¬≤','28 cm¬≤','56 cm¬≤','84 cm¬≤'], a:0, exp:'14√ó14=196'}
  ]
};
function getCustomPacks(){ return LS.get('packs',{}); }
function saveCustomPack(title,tag,qs){
  const packs=getCustomPacks();
  packs[title]={tag,qs};
  LS.set('packs',packs);
}
function allPacks(){ return {...bank_builtin, ...getCustomPacks()}; }

function populatePaketOptions(){
  const sel=document.getElementById('paket');
  const packs=allPacks();
  sel.innerHTML='';
  Object.keys(packs).forEach(k=>{
    const opt=document.createElement('option');
    opt.textContent=k;
    sel.appendChild(opt);
  });
}
populatePaketOptions();

// Quiz
const mulaiQuiz=document.getElementById('mulaiQuiz'), areaQuiz=document.getElementById('areaQuiz');
mulaiQuiz.onclick=()=>{
  const paket=document.getElementById('paket').value;
  const jml=parseInt(document.getElementById('jumlah').value);
  const bank=allPacks()[paket];
  if(!bank){ alert('Paket tidak ditemukan'); return; }
  const qs=[...bank.qs||bank].sort(()=>Math.random()-0.5).slice(0,jml);
  runQuiz(paket,qs);
};
function runQuiz(paket,qs){
  let idx=0, benar=0;
  areaQuiz.innerHTML='';
  function show(){
    if(idx>=qs.length){
      const skor=Math.round(100*benar/qs.length);
      areaQuiz.innerHTML=`<div class="question"><h3>Selesai!</h3><p>Benar ${benar} dari ${qs.length} soal.<br><b>Skor: ${skor}</b></p></div>`;
      const arr=LS.get('skor',[]);
      arr.push({id:uid(),time:now(),paket,benar,total:qs.length,skor});
      LS.set('skor',arr); renderSkor(); renderKPI(); return;
    }
    const q=qs[idx];
    areaQuiz.innerHTML=`<div class="question"><b>Soal ${idx+1}/${qs.length}</b><br>${q.q}<div class="options">${q.opts.map((op,i)=>`<div class="opt" data-i="${i}">${op}</div>`).join('')}</div></div>`;
    areaQuiz.querySelectorAll('.opt').forEach(o=>o.onclick=()=>{
      if(parseInt(o.dataset.i)===q.a){ benar++; o.style.background='rgba(40,200,129,.3)'; }
      else{ o.style.background='rgba(255,93,93,.3)'; }
      setTimeout(()=>{idx++;show();},500);
    });
  }
  show();
}
const tabelSkor=document.querySelector('#tabelSkor tbody');
function renderSkor(){
  const arr=LS.get('skor',[]);
  if(!arr.length){ tabelSkor.innerHTML='<tr><td colspan=5 class="small">Belum ada riwayat.</td></tr>'; return; }
  tabelSkor.innerHTML=arr.map(s=>`<tr><td>${s.time}</td><td>${s.paket}</td><td>${s.benar}</td><td>${s.total}</td><td>${s.skor}</td></tr>`).join('');
}
renderSkor();

// KPI
function renderKPI(){
  document.getElementById('kpiTodoAktif').textContent=LS.get('todo',[]).filter(x=>!x.selesai).length;
  document.getElementById('kpiTodoSelesai').textContent=LS.get('todo',[]).filter(x=>x.selesai).length;
  document.getElementById('kpiJadwal').textContent=LS.get('jadwal',[]).length;
  const arr=LS.get('skor',[]); document.getElementById('kpiSkor').textContent=arr.length? Math.round(arr.reduce((a,b)=>a+b.skor,0)/arr.length):0;
}

// Builder
const addQ=document.getElementById('addQ'), qInputs=document.getElementById('qInputs');
addQ.onclick=()=>{ qInputs.insertAdjacentHTML('beforeend',`<div class="qbox"><input class="qtext" placeholder="Pertanyaan"><div class="qrow"><input class="opt0" placeholder="Opsi A"><input type="radio" name="c${uid()}" value="0"></div><div class="qrow"><input class="opt1" placeholder="Opsi B"><input type="radio" name="c${uid()}" value="1"></div><div class="qrow"><input class="opt2" placeholder="Opsi C"><input type="radio" name="c${uid()}" value="2"></div><div class="qrow"><input class="opt3" placeholder="Opsi D"><input type="radio" name="c${uid()}" value="3"></div><input class="exp" placeholder="Pembahasan (opsional)"></div>`); };
document.getElementById('clearInputs').onclick=()=>{ qInputs.innerHTML=''; };
document.getElementById('savePkg').onclick=()=>{
  const title=document.getElementById('pkgTitle').value.trim();
  const tag=document.getElementById('pkgTag').value.trim();
  if(!title) return alert('Judul kosong');
  const qs=[...qInputs.querySelectorAll('.qbox')].map(b=>{
    const q=b.querySelector('.qtext').value;
    const opts=[0,1,2,3].map(i=>b.querySelector('.opt'+i).value);
    const radios=b.querySelectorAll('input[type=radio]');
    let a=[...radios].find(r=>r.checked)?.value;
    return {q,opts,a:parseInt(a),exp:b.querySelector('.exp').value};
  });
  saveCustomPack(title,tag,qs);
  qInputs.innerHTML=''; document.getElementById('pkgTitle').value=''; document.getElementById('pkgTag').value='';
  populatePaketOptions();
  alert('Paket tersimpan!');
};

// Export / Import
document.getElementById('exportJSON').onclick=()=>{
  const data={jadwal:LS.get('jadwal',[]),todo:LS.get('todo',[]),packs:LS.get('packs',{}),skor:LS.get('skor',[])};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='belajar-smp.json'; a.click();
};
document.getElementById('importFile').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{
    try{ const d=JSON.parse(r.result); if(d.jadwal)LS.set('jadwal',d.jadwal); if(d.todo)LS.set('todo',d.todo); if(d.packs)LS.set('packs',d.packs); if(d.skor)LS.set('skor',d.skor);
      renderJadwal(); renderTodo(); renderSkor(); renderKPI(); populatePaketOptions();
    }catch(err){ alert('File tidak valid'); }
  }; r.readAsText(f);
};
document.getElementById('exportPDF').onclick=()=>{ alert('Ekspor PDF: fitur ini perlu integrasi jsPDF (bisa ditambahkan).'); };
document.getElementById('shareWa').onclick=()=>{ const url='https://wa.me/?text='+encodeURIComponent('Laporan belajar SMP saya sudah siap.'); window.open(url,'_blank'); };

// ========== ADMIN ==========
const AdminModal=document.getElementById('modalAdmin');
document.getElementById('btnAdmin').onclick=showAdmin;
document.getElementById('closeAdmin').onclick=()=>{AdminModal.style.display='none';AdminModal.setAttribute('aria-hidden','true');};

const Auth={ login(){LS.set('isAdmin',true)}, logout(){LS.set('isAdmin',false)}, isAdmin(){return !!LS.get('isAdmin',false)}, async setPassword(p){const h=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(p)); LS.set('admin_hash',Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''));}, async check(p){const h=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(p)); const s=Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join(''); return s===LS.get('admin_hash'); }};

// fungsi render admin packs
function renderAdminPacks(){
  const packs=getCustomPacks();
  const div=document.getElementById('adminPacks');
  if(!Object.keys(packs).length){ div.innerHTML='<div class="small">Belum ada paket kustom.</div>'; return; }
  div.innerHTML=Object.keys(packs).map(k=>`<div class="item"><div class="grow"><b>${k}</b><br><span class="small">${packs[k].tag||''}</span></div><button class="btn danger" data-delpack="${k}">Hapus</button></div>`).join('');
  div.querySelectorAll('[data-delpack]').forEach(b=>b.onclick=()=>{
    if(!confirm('Hapus paket '+b.dataset.delpack+'?'))return;
    const packs=getCustomPacks(); delete packs[b.dataset.delpack]; LS.set('packs',packs); renderAdminPacks(); populatePaketOptions();
  });
}

// fungsi render lock select
function renderLockSelect(){
  const packs=allPacks();
  const div=document.getElementById('lockSelect');
  const locked=LS.get('lockedPacks',[]);
  if(!Object.keys(packs).length){ div.innerHTML='<div class="small">Belum ada paket.</div>'; return; }
  div.innerHTML=Object.keys(packs).map(k=>{
    const isLocked=locked.includes(k);
    return `<div class="item"><div class="grow">${k}</div><button class="btn ${isLocked?'warn':'ghost'}" data-lock="${k}">${isLocked?'Buka':'Kunci'}</button></div>`;
  }).join('');
  div.querySelectorAll('[data-lock]').forEach(b=>b.onclick=()=>{
    const k=b.dataset.lock;
    let arr=LS.get('lockedPacks',[]);
    if(arr.includes(k)){ arr=arr.filter(x=>x!==k); }
    else arr.push(k);
    LS.set('lockedPacks',arr);
    renderLockSelect();
  });
}

async function showAdmin(){
  AdminModal.style.display='flex';
  AdminModal.removeAttribute('aria-hidden');
  const hash = LS.get('admin_hash', null);
  const adminArea=document.getElementById('adminArea');
  adminArea.innerHTML='';
  if(!hash){
    adminArea.innerHTML = `<div style="margin-top:8px"><label>Set Admin Password (baru)</label><input id="newPass" type="password"></div><div style="margin-top:8px"><button class="btn primary" id="setPass">Set Password</button></div>`;
    document.getElementById('setPass').onclick=async()=>{const p=document.getElementById('newPass').value.trim(); if(!p) return alert('Kosong'); await Auth.setPassword(p); alert('Password tersimpan'); Auth.login(); showAdmin();};
    return;
  }
  if(!Auth.isAdmin()){
    adminArea.innerHTML = `<div style="margin-top:8px"><label>Password Admin</label><input id="loginPass" type="password"></div><div style="margin-top:8px"><button class="btn primary" id="doLogin">Login</button></div>`;
    document.getElementById('doLogin').onclick=async()=>{const p=document.getElementById('loginPass').value; if(!p) return; const ok=await Auth.check(p); if(ok){Auth.login();showAdmin();}else alert('Salah');};
    return;
  }
  adminArea.innerHTML=`
    <div class="small">Status: <b>Admin</b></div>
    <div style="margin-top:10px"><button class="btn ghost" id="btnLogout">Logout</button></div>
    <hr>
    <div style="margin-top:8px"><h4>Edit / Hapus Paket Kustom</h4><div id="adminPacks"></div></div>
    <hr>
    <div style="margin-top:8px"><h4>Kunci Paket</h4><div id="lockSelect"></div></div>
    <hr>
    <div style="margin-top:8px"><h4>Riwayat Latihan</h4><div class="small">Hapus semua riwayat skor latihan.</div><div style="margin-top:8px"><button class="btn danger" id="adminClearSkor">üóë Hapus Riwayat Skor</button></div></div>
    <hr>
    <div style="margin-top:8px"><h4>Ganti Password Admin</h4><label>Password Lama</label><input id="oldPass" type="password"><label>Password Baru</label><input id="newPass2" type="password"><div style="margin-top:8px"><button class="btn primary" id="changePass">Ganti Password</button></div></div>
  `;
  document.getElementById('btnLogout').onclick=()=>{Auth.logout();showAdmin();};
  renderAdminPacks();
  renderLockSelect();
  if(document.getElementById('adminClearSkor')){
    document.getElementById('adminClearSkor').onclick=()=>{
      if(!confirm('Yakin ingin hapus semua riwayat skor latihan?')) return;
      LS.set('skor',[]);
      renderSkor(); renderKPI();
      alert('Riwayat skor berhasil dihapus');
    };
  }
  if(document.getElementById('changePass')){
    document.getElementById('changePass').onclick=async()=>{
      const oldp=document.getElementById('oldPass').value;
      const newp=document.getElementById('newPass2').value;
      if(!oldp||!newp) return alert('Isi semua kolom');
      const ok=await Auth.check(oldp);
      if(!ok) return alert('Password lama salah');
      await Auth.setPassword(newp);
      alert('Password admin diganti');
      Auth.logout();
      showAdmin();
    };
  }
}
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registered"))
    .catch(err => console.error("SW registration failed:", err));
}
</script>


</body></html>